<%- include("partials/profileHeader.ejs") %>
<title>My Orders</title>
<!-- SweetAlert2 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f8f9fa;
        margin: 20px;
        padding: 0;
    }

    .order-container {
        max-width: 1000px;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        margin: auto;
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        padding: 10px;
        text-align: center;
        border-bottom: 1px solid #ddd;
    }

    th {
        background-color: #007bff;
        color: white;
    }

    .product-image img {
        width: 60px;
        border-radius: 5px;
    }

    .btn {
        padding: 6px 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
    }

    .view-btn {
        background-color: #17a2b8;
        color: #fff;
    }

    .cancel-btn {
        background-color: #dc3545;
        color: #fff;
    }

    @media (max-width: 768px) {
        table {
            font-size: 12px;
        }

        .btn {
            padding: 4px 8px;
            font-size: 12px;
        }
    }
</style>
</head>
<body>
    <div class="order-container">
        <table>
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Product Name</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <% orders.forEach(element => { %>
                    <tr>
                        <td class="product-image">
                            <img src="<%= element.productDetails[0].images[0] %>" alt="Product Image">
                        </td>
                        <td><%= element.productDetails[0].name %></td>
                        <td><%= element.orderItem.quantity %></td>
                        <td>â‚¹ <%= element.orderItem.price %></td>
                        <td>
                            <input type="hidden" value="<%= element._id %>" class="orderId">
                            <input type="hidden" value="<%= element.orderItem._id %>" class="materialId">
                          <a href="/user/orderDetailss/<%= element._id %>?product=<%= element.orderItem._id %>">
    <button class="btn view-btn">View</button>
</a>




                            <button class="btn cancel-btn">Cancel</button>
                        </td>
                    </tr>
                <% }) %>
            </tbody>
        </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script>
        document.querySelectorAll(".cancel-btn").forEach(button => {
            button.addEventListener("click", async (event) => {
                event.preventDefault();
                
                const row = event.target.closest("tr");
                const orderId = row.querySelector(".orderId").value;
                const materialId = row.querySelector(".materialId").value;
                
                const confirmCancel = await Swal.fire({
                    title: "Are you sure?",
                    text: "You won't be able to revert this!",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Yes, cancel it!",
                    cancelButtonText: "No, keep it"
                });

                if (confirmCancel.isConfirmed) {
                    try {
                        const response = await fetch("/user/cancelOrder", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ orderId, materialId })
                        });

                        const result = await response.json();
                        if (result.success) {
                            Swal.fire("Cancelled!", "Your order has been cancelled.", "success")
                                .then(() => { window.location.reload(); });
                        } else {
                            Swal.fire("Error!", "Something went wrong. Try again.", "error");
                        }
                    } catch (error) {
                        console.error(error);
                        Swal.fire("Error!", "Failed to cancel the order.", "error");
                    }
                }
            });
        });
    </script>
</body>
</html>